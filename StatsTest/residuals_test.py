import numpy as np
from StatsTest.utils import _check_table


def durbin_watson_test(resids, n_samples=1, alpha=0.05):
    if alpha not in [0.01, 0.05]:
        raise ValueError("Cannot determine alpha level")
    if n_samples <= 5:
        raise ValueError("Number of features needs to be greater than 5")
    if n_samples <= 40:
        index = n_samples - 6
    elif n_samples <= 100:
        index = (np.around(n_samples / 5, decimals=0) * 5) - 6
    else:
        index = (np.around(n_samples / 50, decimals=0) * 50) - 6
    n_features = len(resids)
    resids = _check_table(resids, only_count=False)
    auto_corr = np.diff(resids, n=1, axis=0)
    d = np.sum(np.power(auto_corr, 2)) / np.sum(np.power(resids, 2))
    q_01 = [[(0.390, 1.142)],
            [(0.435, 1.036), (0.294, 1.676)],
            [(0.497, 1.003), (0.345, 1.489), (0.229, 2.101)],
            [(0.554, 0.998), (0.408, 1.389), (0.279, 1.875), (0.183, 2.433)],
            [(0.604, 1.001), (0.466, 1.333), (0.340, 1.733), (0.230, 2.193), (0.150, 2.690)],
            [(0.653, 1.010), (0.519, 1.297), (0.396, 1.640), (0.286, 2.030), (0.193, 2.453), (0.124, 2.892)],
            [(0.697, 1.023), (0.569, 1.274), (0.449, 1.575), (0.339, 1.913), (0.244, 2.280), (0.164, 2.665), (0.105, 3.053)],
            [(0.738, 1.038), (0.616, 1.261), (0.499, 1.526), (0.391, 1.826), (0.294, 2.150), (0.211, 2.490), (0.104, 2.838), (0.090, 3.182)],
            [(0.776, 1.054), (0.660, 1.254), (0.547, 1.490), (0.441, 1.757), (0.343, 2.049), (0.257, 2.354), (0.183, 2.667), (0.122, 2.981), (0.078, 3.287)],
            [(0.811, 1.070), (0.700, 1.252), (0.591, 1.465), (0.487, 1.705), (0.390, 1.967), (0.303, 2.244), (0.226, 2.530), (0.161, 2.817), (0.107, 3.101), (0.068, 3.374)],
            [(0.844, 1.086), (0.738, 1.253), (0.633, 1.447), (0.532, 1.664), (0.437, 1.901), (0.349, 2.153), (0.269, 2.416), (0.200, 2.681), (0.142, 2.944), (0.094, 3.201), (0.060, 3.446)],
            [(0.873, 1.102), (0.773, 1.255), (0.672, 1.432), (0.574, 1.631), (0.481, 1.847), (0.393, 2.078), (0.313, 2.319), (0.241, 2.566), (0.179, 2.811), (0.127, 3.053), (0.084, 3.286), (0.053, 3.506)],
            [(0.902, 1.118), (0.805, 1.259), (0.708, 1.422), (0.614, 1.604), (0.522, 1.803), (0.435, 2.105), (0.355, 2.238), (0.282, 2.467), (0.216, 2.697), (0.160, 2.925), (0.113, 3.146), (0.075, 3.358), (0.047, 3.557)],
            [(0.928, 1.133), (0.835, 1.264), (0.742, 1.416), (0.650, 1.583), (0.561, 1.767), (0.476, 1.963), (0.396, 2.169), (0.322, 2.381), (0.255, 2.597), (0.196, 2.813), (0.145, 3.023), (0.102, 3.227), (0.067, 3.420), (0.043, 3.601)],
            [(0.952, 1.147), (0.862, 1.270), (0.774, 1.410), (0.684, 1.567), (0.598, 1.736), (0.515, 1.918), (0.436, 2.110), (0.362, 2.308), (0.294, 2.510), (0.232, 2.174), (0.178, 2.914), (0.131, 3.109), (0.092, 3.297), (0.061, 3.474), (0.038, 3.639)],
            [(0.975, 1.161), (0.889, 1.276), (0.803, 1.408), (0.718, 1.554), (0.634, 1.712), (0.553, 1.881), (0.474, 2.059), (0.400, 2.244), (0.331, 2.434), (0.268, 2.625), (0.212, 2.817), (0.162, 3.004), (0.119, 3.185), (0.084, 3.358), (0.055, 3.521), (0.035, 3.671)],
            [(0.997, 1.174), (0.915, 1.284), (0.832, 1.407), (0.748, 1.543), (0.666, 1.691), (0.587, 1.849), (0.510, 2.105), (0.437, 2.188), (0.368, 2.367), (0.304, 2.548), (0.246, 2.729), (0.194, 2.909), (0.148, 3.084), (0.109, 3.252), (0.077, 3.412), (0.050, 3.562), (0.032, 3.700)],
            [(1.017, 1.186), (0.938, 1.290), (0.858, 1.407), (0.777, 1.535), (0.699, 1.674), (0.620, 1.821), (0.545, 1.977), (0.473, 2.140), (0.404, 2.308), (0.340, 2.479), (0.281, 2.651), (0.227, 2.822), (0.178, 2.991), (0.136, 3.155), (0.100, 3.311), (0.070, 3.459), (0.046, 3.597), (0.029, 3.725)],
            [(1.037, 1.199), (0.959, 1.298), (0.881, 1.407), (0.805, 1.527), (0.728, 1.659), (0.652, 1.797), (0.578, 1.944), (0.507, 2.097), (0.439, 2.255), (0.375, 2.417), (0.315, 2.580), (0.260, 2.744), (0.209, 2.906), (0.165, 3.065), (0.125, 3.218), (0.092, 3.363), (0.065, 3.501), (0.043, 3.629), (0.027, 3.747)],
            [(1.055, 1.210), (0.981, 1.305), (0.906, 1.408), (0.832, 1.521), (0.756, 1.645), (0.682, 1.776), (0.610, 1.915), (0.540, 2.059), (0.473, 2.209), (0.409, 2.362), (0.348, 2.517), (0.292, 2.674), (0.240, 2.829), (0.194, 2.982), (0.152, 3.131), (0.116, 3.274), (0.085, 3.410), (0.060, 3.538), (0.039, 3.657), (0.025, 3.766)],
            [(1.072, 1.222), (1.000, 1.311), (0.928, 1.410), (0.855, 1.517), (0.782, 1.635), (0.711, 1.759), (0.640, 1.889), (0.572, 2.026), (0.505, 2.168), (0.441, 2.313), (0.381, 2.460), (0.324, 2.610), (0.272, 2.758), (0.224, 2.906), (0.180, 3.050), (0.141, 3.191), (0.107, 3.325), (0.079, 3.452), (0.055, 3.572), (0.036, 3.682)],
            [(1.088, 1.232), (1.019, 1.318), (0.948, 1.413), (0.878, 1.514), (0.808, 1.625), (0.738, 1.743), (0.669, 1.867), (0.602, 1.997), (0.536, 2.131), (0.473, 2.269), (0.413, 2.409), (0.356, 2.552), (0.303, 2.694), (0.253, 2.836), (0.208, 2.976), (0.167, 3.113), (0.131, 3.245), (0.100, 3.371), (0.073, 3.490), (0.051, 3.602)],
            [(1.104, 1.244), (1.036, 1.325), (0.969, 1.414), (0.901, 1.512), (0.832, 1.618), (0.764, 1.729), (0.696, 1.847), (0.630, 1.970), (0.466, 2.098), (0.504, 2.229), (0.444, 2.363), (0.387, 2.499), (0.333, 2.635), (0.283, 2.772), (0.237, 2.907), (0.194, 3.040), (0.156, 3.169), (0.122, 3.294), (0.093, 3.412), (0.068, 3.524)],
            [(1.119, 1.254), (1.053, 1.332), (0.988, 1.418), (0.921, 1.511), (0.855, 1.611), (0.788, 1.718), (0.723, 1.830), (0.658, 1.947), (0.595, 2.068), (0.533, 2.193), (0.474, 2.321), (0.417, 2.451), (0.363, 2.582), (0.313, 2.713), (0.266, 2.843), (0.222, 2.972), (0.182, 3.098), (0.146, 3.220), (0.114, 3.338), (0.087, 3.450)],
            [(1.134, 1.264), (1.070, 1.339), (1.006, 1.421), (0.941, 1.510), (0.877, 1.606), (0.812, 1.707), (0.748, 1.814), (0.684, 1.925), (0.622, 2.041), (0.562, 2.160), (0.503, 2.283), (0.447, 2.407), (0.393, 2.533), (0.342, 2.659), (0.294, 2.785), (0.249, 2.909), (0.208, 3.032), (0.171, 3.152), (0.137, 3.267), (0.107, 3.379)],
            [(1.147, 1.274)],
            [(1.160, 1.283)],
            [(1.171, 1.291)],
            [(1.184, 1.298)],
            [(1.195, 1.307)],
            [(1.205, 1.315)],
            [(1.217, 1.322)],
            [(1.227, 1.330)],
            [(1.237, 1.337)],
            [(1.246, 1.344)],
            [(1.288, 1.376)],
            [(1.324, 1.403)]]

